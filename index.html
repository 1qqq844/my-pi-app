<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的第一个 Pi DApp</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #673ab7; color: white; border: none; border-radius: 5px; }
        #user-info { margin-top: 20px; color: green; }
    </style>
</head>
<body>

    <h1>欢迎来到我的 Pi DApp</h1>
    
    <button onclick="login()">点击登录 Pi 账号</button>
    
    <div id="user-info"></div>

    <hr>

    <h3>支持一下：支付 1 Test-Pi</h3>
    <button onclick="transferPi()">发起支付</button>

    <script>
        // 1. 初始化 SDK (sandbox: true 代表测试模式)
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: true });

        // 2. 登录函数
        async function login() {
            try {
                const scopes = ['username', 'payments'];
                const user = await Pi.authenticate(scopes, onIncompletePaymentFound);
                document.getElementById('user-info').innerText = "你好, " + user.user.username;
                console.log("登录成功", user);
            } catch (err) {
                alert("登录失败，请在 Pi Browser 中打开");
            }
        }

        // 3. 支付函数
        async function transferPi() {
            const paymentData = {
                amount: 1,
                memo: "这是给新手的测试订单",
                metadata: { orderId: 12345 }
            };

            const callbacks = {
                onReadyForServerApproval: (paymentId) => {
                    console.log("等待服务器批准:", paymentId);
                    // 提示：正式开发需要后端处理，小白测试可以先看控制台
                    alert("支付已提交，等待处理 (ID: " + paymentId + ")");
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    console.log("支付完成:", txid);
                    alert("支付成功！感谢支持。");
                },
                onCancel: (paymentId) => { console.log("用户取消支付"); },
                onError: (error, payment) => { console.error("支付出错", error); }
            };

            Pi.createPayment(paymentData, callbacks);
        }

        // 4. 处理未完成的支付（SDK要求必须有此回调）
        function onIncompletePaymentFound(payment) {
            console.log("发现未完成的支付", payment);
        };
    </script>
</body>
</html>
