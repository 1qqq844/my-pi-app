<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº¦éœ¸é¢åŒ…åº— - Pi æµ‹è¯•</title>
    
    <meta name="pi-sdk-version" content="2.0">
    <link rel="canonical" href="https://1qqq844.github.io/my-pi-app/">

    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background-color: #f4f4f9; }
        .card { background: white; margin: 20px auto; padding: 20px; width: 85%; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        h1 { color: #673ab7; }
        button { width: 80%; padding: 15px; font-size: 18px; cursor: pointer; background: #673ab7; color: white; border: none; border-radius: 8px; margin: 10px 0; font-weight: bold; }
        button:active { background: #512da8; transform: scale(0.98); }
        .status { color: #666; font-size: 12px; margin-top: 30px; background: #eee; padding: 10px; }
        #user-display { color: #2e7d32; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="card">
        <h1>éº¦éœ¸é¢åŒ…åº— ğŸ¥</h1>
        <div id="user-display">æœªç™»å½•çŠ¶æ€</div>
        <button onclick="login()">1. ç‚¹å‡»ç™»å½•å¹¶æˆæƒ</button>
    </div>

    <div class="card">
        <h3>ä»Šæ—¥ç‰¹æƒ </h3>
        <p>æ‰‹å·¥å¥¶æ²¹é¢åŒ…ï¼š0.1 Test-Pi</p>
        <button onclick="transferPi()" style="background: #ef6c00;">2. ç«‹å³ä¸‹å•æ”¯ä»˜</button>
    </div>

    <div id="status-box" class="status">SDK çŠ¶æ€: æ­£åœ¨åŠ è½½ç¯å¢ƒ...</div>

    <script>
        const Pi = window.Pi;

        // åˆå§‹åŒ– SDK
        try {
            // åœ¨ Pi Browser çœŸå®ç¯å¢ƒæµ‹è¯•ï¼Œsandbox è®¾ä¸º false
            Pi.init({ version: "2.0", sandbox: false });
            document.getElementById('status-box').innerText = "SDK çŠ¶æ€: åˆå§‹åŒ–æˆåŠŸ";
        } catch (err) {
            document.getElementById('status-box').innerText = "SDK çŠ¶æ€: åˆå§‹åŒ–å¤±è´¥ (è¯·åœ¨ Pi Browser ä¸­æ‰“å¼€)";
        }

        /**
         * ç™»å½•å¹¶è·å– scope æƒé™
         * æ³¨æ„ï¼šå¿…é¡»åŒ…å« 'payments' æ‰èƒ½åœ¨åç»­å‘èµ·æ”¯ä»˜
         */
        async function login() {
            console.log("æ­£åœ¨è°ƒèµ·æˆæƒ...");
            try {
                const scopes = ['username', 'payments']; 
                const user = await Pi.authenticate(scopes, onIncompletePaymentFound);
                
                // ç™»å½•æˆåŠŸå¤„ç†
                document.getElementById('user-display').innerText = "æ¬¢è¿å›æ¥: " + user.user.username;
                alert("æˆæƒæˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥è¿›è¡Œä¸‹å•æ”¯ä»˜äº†ã€‚");
            } catch (err) {
                console.error(err);
                alert("æˆæƒå¤±è´¥: " + err.message + "\nè¯·ç¡®ä¿æ‚¨åœ¨ Pi Browser ä¸­æ‰“å¼€ä¸”ç½‘å€æ­£ç¡®ã€‚");
            }
        }

        /**
         * å‘èµ·æ”¯ä»˜è¯·æ±‚
         */
        async function transferPi() {
            try {
                const paymentData = {
                    amount: 0.1,
                    memo: "è´­ä¹°éº¦éœ¸æ‰‹å·¥é¢åŒ…",
                    metadata: { orderId: "Bread-" + Math.floor(Date.now() / 1000) }
                };

                const callbacks = {
                    onReadyForServerApproval: (paymentId) => {
                        // æ­¤æ—¶æ”¯ä»˜å·²åœ¨ Pi æœåŠ¡å™¨åˆ›å»ºï¼Œç­‰å¾…å¼€å‘è€…åç«¯æ‰¹å‡†
                        alert("æ”¯ä»˜è¯·æ±‚å·²å‘é€ï¼\nPaymentID: " + paymentId + "\n(æç¤ºï¼šç”±äºç›®å‰æ— åç«¯ï¼Œæ”¯ä»˜å°†åœç•™åœ¨ Pending çŠ¶æ€)");
                    },
                    onReadyForServerCompletion: (paymentId, txid) => {
                        // æ”¯ä»˜æœ€ç»ˆå®Œæˆ
                        alert("æ”¯ä»˜åœ†æ»¡å®Œæˆï¼\näº¤æ˜“å“ˆå¸Œ: " + txid);
                    },
                    onCancel: (paymentId) => { 
                        console.log("ç”¨æˆ·å–æ¶ˆæ”¯ä»˜: ", paymentId); 
                    },
                    onError: (error, payment) => { 
                        alert("æ”¯ä»˜è¿‡ç¨‹å‡ºé”™: " + error.message); 
                    }
                };

                console.log("æ­£åœ¨æ‹‰èµ·é’±åŒ…...");
                // è°ƒç”¨ SDK å‘èµ·æ”¯ä»˜
                Pi.createPayment(paymentData, callbacks);
            } catch (err) {
                // å¦‚æœæŠ¥é”™ "Cannot create a payment without payments scope"ï¼Œè¯´æ˜æ²¡è·‘é€š login()
                alert("æ‹‰èµ·é’±åŒ…å¤±è´¥: " + err.message);
            }
        }

        /**
         * å¤„ç†æœªå®Œæˆæ”¯ä»˜çš„å›è°ƒ (SDK å¼ºåˆ¶è¦æ±‚)
         */
        function onIncompletePaymentFound(payment) {
            console.log("å‘ç°ä¸€ç¬”æœªå®Œæˆçš„æ”¯ä»˜è®¢å•: ", payment);
            // æ­£å¼å¼€å‘ä¸­ï¼Œæ­¤å¤„åº”å°† paymentId å‘å¾€åç«¯è¿›è¡Œé‡è¯•æˆ–å–æ¶ˆ
        };
    </script>
</body>
</html>
